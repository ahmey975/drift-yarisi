<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Murat Şener Ultimate Drift Yarışı - DÜZELTİLMİŞ</title>

    <link rel="manifest" href="./manifest.json"> 
    <meta name="theme-color" content="#212121">

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* (CSS aynı, kısalttım) */
        body, html { margin:0; padding:0; height:100%; width:100%; font-family:'Roboto',sans-serif; background:#1a1a1a; color:#eee; overflow:hidden }
        #gameCanvas { display:block; width:100%; height:100%; background:#000 }
        .overlay-screen{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.9);z-index:100;opacity:0;pointer-events:none;transition:opacity .4s}
        .overlay-screen.active{opacity:1;pointer-events:auto}
        .input-group input{padding:10px;border-radius:6px;border:2px solid #555;background:#333;color:#fff}
        .car-options{display:flex;flex-wrap:wrap;gap:12px;justify-content:center}
        .car-card{background:#2a2a2a;padding:12px;border-radius:10px;border:2px solid #444;width:150px}
        #game-info{position:absolute;top:0;left:0;width:100%;display:flex;justify-content:space-around;z-index:90;padding:8px;background:rgba(0,0,0,.6)}
        #game-controls{position:absolute;bottom:0;width:100%;display:flex;justify-content:space-between;padding:10px;z-index:90}
        #loading-screen{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#1a1a1a;z-index:101}
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>

    <div id="loading-screen"><div>Oyun Yükleniyor...</div></div>

    <div id="start-screen" class="overlay-screen active">
        <div style="text-align:center;max-width:420px">
            <h1>Murat Şener Ultimate Drift Yarışı</h1>
            <p>Merhaba, lütfen adınızı girin:</p>
            <div class="input-group"><input id="playerNameInput" placeholder="Adınız" maxlength="15"></div>
            <div style="margin-top:12px"><button id="goToCarSelection">DEVAM ET</button></div>
        </div>
    </div>

    <div id="car-selection-screen" class="overlay-screen">
        <div style="text-align:center;max-width:900px;width:100%">
            <h2>Araba Seçimi</h2>
            <p>Hoş geldin <span id="displayPlayerName"></span>! Arabanı seç ve pistleri fethet!</p>
            <div class="car-options"></div>
            <div style="margin-top:10px">Jetonların: <span id="currentCoinsDisplay">0</span></div>
            <div style="margin-top:12px"><button id="startGameButton">OYUNA BAŞLA</button></div>
        </div>
    </div>

    <div id="game-info" style="display:none">
        <div>Hız: <span id="speedDisplay">0</span> km/s</div>
        <div>Skor: <span id="scoreDisplay">0</span></div>
        <div>Drift: <span id="driftScoreDisplay">0</span></div>
        <div>Jeton: <span id="coinsDisplay">0</span></div>
    </div>

    <div id="game-controls" style="display:none">
        <div><button id="leftButton">⬅️</button><button id="rightButton">➡️</button></div>
        <div><button id="accelerateButton">⬆️</button><button id="brakeButton">⬇️</button></div>
    </div>

    <div id="end-game-screen" class="overlay-screen">
        <div style="text-align:center">
            <h1>OYUN BİTTİ!</h1>
            <p>Tebrikler <span id="finalPlayerName"></span>!</p>
            <p>Final Skorun: <span id="finalScoreDisplay">0</span></p>
            <p>Toplam Jeton: <span id="finalCoinsCollectedDisplay">0</span></p>
            <div style="margin-top:10px"><button id="restartGameButton">YENİDEN BAŞLA</button> <button id="backToSelectionButton">ARABA SEÇİMİNE DÖN</button></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.158.0/three.min.js"></script>

    <script>
    // --- DOM ---
    const canvas = document.getElementById('gameCanvas');
    const loadingScreen = document.getElementById('loading-screen');
    const startScreen = document.getElementById('start-screen');
    const playerNameInput = document.getElementById('playerNameInput');
    const goToCarSelection = document.getElementById('goToCarSelection');
    const carSelectionScreen = document.getElementById('car-selection-screen');
    const carOptions = document.querySelector('.car-options');
    const displayPlayerName = document.getElementById('displayPlayerName');
    const currentCoinsDisplay = document.getElementById('currentCoinsDisplay');
    const startGameButton = document.getElementById('startGameButton');
    const gameInfo = document.getElementById('game-info');
    const gameControls = document.getElementById('game-controls');
    const leftButton = document.getElementById('leftButton');
    const rightButton = document.getElementById('rightButton');
    const accelerateButton = document.getElementById('accelerateButton');
    const brakeButton = document.getElementById('brakeButton');
    const speedDisplay = document.getElementById('speedDisplay');
    const scoreDisplay = document.getElementById('scoreDisplay');
    const driftScoreDisplay = document.getElementById('driftScoreDisplay');
    const coinsDisplay = document.getElementById('coinsDisplay');
    const endGameScreen = document.getElementById('end-game-screen');
    const finalPlayerName = document.getElementById('finalPlayerName');
    const finalScoreDisplay = document.getElementById('finalScoreDisplay');
    const finalCoinsCollectedDisplay = document.getElementById('finalCoinsCollectedDisplay');
    const restartGameButton = document.getElementById('restartGameButton');
    const backToSelectionButton = document.getElementById('backToSelectionButton');

    // --- state ---
    let playerName = '';
    let totalCoins = parseInt(localStorage.getItem('totalCoins') || '0');
    let unlockedCars = JSON.parse(localStorage.getItem('unlockedCars') || '["basicCar"]');
    let selectedCarId = localStorage.getItem('selectedCarId') || 'basicCar';
    let selectedCarColor = localStorage.getItem('selectedCarColor') || '#e74c3c';

    // three.js
    let scene, camera, renderer;
    let carMesh = null;
    let coinGeometry, coinMaterial;
    const coins = [];

    let animationId = null;
    let gameActive = false;

    // --- helpers ---
    function showScreen(id){ document.querySelectorAll('.overlay-screen').forEach(s=>s.classList.remove('active')); if(id) document.getElementById(id).classList.add('active'); }
    function hideAllScreens(){ document.querySelectorAll('.overlay-screen').forEach(s=>s.classList.remove('active')); }

    function updateCoinsDisplay(){ currentCoinsDisplay.textContent = totalCoins; coinsDisplay.textContent = totalCoins; localStorage.setItem('totalCoins', totalCoins); }

    // --- three init ---
    function initThree(){
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
        renderer = new THREE.WebGLRenderer({ antialias:true, canvas });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio || 1);
        renderer.setClearColor(0x111111);

        const amb = new THREE.AmbientLight(0xffffff, 0.6); scene.add(amb);
        const dir = new THREE.DirectionalLight(0xffffff, 0.6); dir.position.set(5,10,5); scene.add(dir);

        camera.position.set(0,6,12);
        camera.lookAt(0,0,0);

        coinGeometry = new THREE.CylinderGeometry(0.4,0.4,0.08,16);
        coinMaterial = new THREE.MeshBasicMaterial({ color:0xffd700 });

        window.addEventListener('resize', ()=>{
            camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight);
        });
    }

    // --- car placeholder ---
    function createCarPlaceholder(color){
        if(carMesh) { scene.remove(carMesh); disposeObject(carMesh); carMesh = null; }
        const g = new THREE.BoxGeometry(1.6,0.6,3);
        const m = new THREE.MeshPhongMaterial({ color });
        carMesh = new THREE.Mesh(g,m);
        carMesh.position.set(0,0.5,0);
        scene.add(carMesh);
    }

    function disposeObject(obj){ try{ obj.traverse && obj.traverse(child=>{ if(child.geometry) child.geometry.dispose(); if(child.material){ if(Array.isArray(child.material)){ child.material.forEach(x=>x.dispose()); } else child.material.dispose(); } }); }catch(e){} }

    // --- coins ---
    function spawnCoin(){
        const coin = new THREE.Mesh(coinGeometry, coinMaterial.clone());
        const x = (Math.random()-0.5)*6; const z = -30 + Math.random()*-80; coin.position.set(x,0.6,z);
        scene.add(coin); coins.push(coin);
    }

    function moveCoins(dt){
        for(let i=coins.length-1;i>=0;i--){ const c = coins[i]; c.position.z += dt * 20; if(c.position.z > 20){ scene.remove(c); disposeObject(c); coins.splice(i,1); } }
    }

    function checkCoinCollision(){ if(!carMesh) return; const carBox = new THREE.Box3().setFromObject(carMesh);
        for(let i=coins.length-1;i>=0;i--){ const coin = coins[i]; const coinBox = new THREE.Box3().setFromObject(coin); if(carBox.intersectsBox(coinBox)){ // collect
                    scene.remove(coin); disposeObject(coin); coins.splice(i,1);
                    totalCoins++; updateCoinsDisplay();
                }
        }
    }

    // --- game loop ---
    let lastTime = performance.now();
    function animate(now){
        animationId = requestAnimationFrame(animate);
        const dt = Math.min(0.05, (now - lastTime) / 1000); lastTime = now;
        if(gameActive){ moveCoins(dt); checkCoinCollision(); }
        renderer.render(scene, camera);
    }

    // --- UI & flow ---
    function renderCarOptions(){ carOptions.innerHTML = ''; const cars = [ {id:'basicCar',name:'Başlangıç',cost:0},{id:'sportCar',name:'Spor',cost:50},{id:'proCar',name:'Pro',cost:150} ];
        cars.forEach(c=>{ const el = document.createElement('div'); el.className='car-card'; el.innerHTML = `<h4>${c.name}</h4><div>${c.cost?c.cost+' Jeton':''}</div>`; el.addEventListener('click', ()=>{ if(c.cost>0 && !unlockedCars.includes(c.id)){ if(totalCoins>=c.cost){ if(confirm(`Açmak ister misin? ${c.cost} jeton`)){ totalCoins -= c.cost; unlockedCars.push(c.id); localStorage.setItem('unlockedCars', JSON.stringify(unlockedCars)); updateCoinsDisplay(); selectedCarId = c.id; localStorage.setItem('selectedCarId', selectedCarId); createCarPlaceholder(selectedCarColor); } } else { alert('Yeterli jeton yok'); } } else { selectedCarId=c.id; localStorage.setItem('selectedCarId', selectedCarId); createCarPlaceholder(selectedCarColor); } }); carOptions.appendChild(el); }); }

    goToCarSelection.addEventListener('click', ()=>{
        const val = playerNameInput.value.trim(); if(!val){ alert('Lütfen adınızı girin'); return; }
        playerName = val; localStorage.setItem('playerName', playerName); displayPlayerName.textContent = playerName; updateCoinsDisplay(); renderCarOptions(); showScreen('car-selection-screen'); createCarPlaceholder(selectedCarColor);
    });

    startGameButton.addEventListener('click', ()=>{
        // reset simple state
        gameActive = true; lastTime = performance.now();
        hideAllScreens(); gameInfo.style.display='flex'; gameControls.style.display='flex';
        // spawn initial coins
        for(let i=0;i<10;i++) spawnCoin();
        // spawn coins periodically
        coinSpawner = setInterval(()=>{ if(gameActive) spawnCoin(); }, 900);
        animate(performance.now());
    });

    restartGameButton.addEventListener('click', ()=>{ location.reload(); });
    backToSelectionButton.addEventListener('click', ()=>{ showScreen('car-selection-screen'); gameInfo.style.display='none'; gameControls.style.display='none'; gameActive=false; clearInterval(coinSpawner); });

    // touch / keyboard simple
    window.addEventListener('keydown', e=>{ if(e.code==='ArrowLeft') carMesh && (carMesh.position.x -= 0.5); if(e.code==='ArrowRight') carMesh && (carMesh.position.x += 0.5); if(e.code==='ArrowUp') carMesh && (carMesh.position.z -= 1); if(e.code==='ArrowDown') carMesh && (carMesh.position.z += 1); });

    // --- start up ---
    initThree(); initApp();

    function initApp(){ try{ const saved = localStorage.getItem('playerName'); if(saved) playerNameInput.value = saved; updateCoinsDisplay(); } finally{ setTimeout(()=>{ loadingScreen.classList.add('hidden'); }, 600); }}

    // small cleanup on unload
    window.addEventListener('beforeunload', ()=>{ cancelAnimationFrame(animationId); });
    </script>
</body>
</html>
